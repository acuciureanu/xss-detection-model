<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XSS Fuzzer Report - Alert Triggering Payloads</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; line-height: 1.6; }
        h1, h2, h3 { color: #333; }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f2f2f2; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        .summary { margin-bottom: 30px; background-color: #f0f0f0; padding: 20px; border-radius: 5px; }
        .error-message { color: #ff0000; font-weight: bold; }
        #versionSelector, #pagination { margin-bottom: 20px; }
        select, button, input { padding: 8px; font-size: 16px; margin-right: 10px; }
        button { cursor: pointer; background-color: #4CAF50; color: white; border: none; border-radius: 4px; }
        button:hover { background-color: #45a049; }
        .payload { font-family: monospace; word-break: break-all; }
        .test-button-container { text-align: right; margin-bottom: 20px; }
        .icon { font-size: 18px; vertical-align: middle; }
        .success { color: green; font-weight: bold; }
        .failure { color: red; font-weight: bold; }
        #loadingMessage { display: none; }
        #testAllButton { font-size: 18px; padding: 10px 20px; }
    </style>
</head>
<body>
    <h1>XSS Fuzzer Report - Alert Triggering Payloads</h1>
    <div id="versionSelector">
        <label for="dompurifyVersion">Select DOMPurify version:</label>
        <select id="dompurifyVersion"></select>
        <button onclick="loadSelectedVersion()">Load Version</button>
    </div>
    <input type="file" id="fileInput" accept=".json">
    <button onclick="loadFile()">Load JSON</button>
    <div id="loadingMessage">Loading data, please wait...</div>
    <div class="test-button-container">
        <button id="testAllButton" onclick="testAllPayloads(true)">TEST ALL PAYLOADS</button>
    </div>
    <div id="pagination">
        <button id="prevPage" onclick="changePage(-1)">Previous</button>
        <span id="pageInfo"></span>
        <button id="nextPage" onclick="changePage(1)">Next</button>
        <input type="number" id="pageInput" min="1" step="1">
        <button onclick="goToPage()">Go to Page</button>
    </div>
    <div id="content">
        <p>Select a file to display data...</p>
    </div>

    <script>
        let dompurifyVersions = [];
        let latestVersion = '';
        let reportData = null;
        let currentPage = 1;
        const itemsPerPage = 50;

        function escapeHtml(unsafe) {
            return unsafe
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }

        function encodeSpecialChars(str) {
            return str.replace(/[\u200B-\u200D\uFEFF]/g, char => `\\u${char.charCodeAt(0).toString(16).padStart(4, '0')}`);
        }

        function decodeSpecialChars(str) {
            return str.replace(/\\u([a-fA-F0-9]{4})/g, (_, p1) => String.fromCharCode(parseInt(p1, 16)));
        }

        function createTestButton(payload, index) {
            const buttonId = `test-${index}`;
            const encodedPayload = encodeSpecialChars(payload);
            return `<button id="${buttonId}" onclick="testSinglePayload('${encodedPayload}', ${index})">TEST</button>`;
        }

        async function testSinglePayload(encodedPayload, index) {
            const payload = decodeSpecialChars(encodedPayload);
            console.log('Testing payload:', payload);

            // Save the original alert function
            const originalAlert = window.alert;

            // Override the alert function
            window.alert = function(msg) {
                console.log('Alert triggered:', msg);
                document.getElementById(`result-${index}`).innerHTML = '✅ Alert Triggered';
                document.getElementById(`result-${index}`).className = 'success';
            };

            try {
                // Sanitize the payload using DOMPurify
                const sanitized = DOMPurify.sanitize(payload);

                // Create a temporary div to hold the sanitized content
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = sanitized;

                // Append the div to the body (this might trigger the XSS if it bypassed DOMPurify)
                document.body.appendChild(tempDiv);

                // Wait a short time to allow for any asynchronous XSS to execute
                await new Promise(resolve => setTimeout(resolve, 100));

                // If no alert was triggered, mark as blocked
                if (document.getElementById(`result-${index}`).innerHTML !== '✅ Alert Triggered') {
                    document.getElementById(`result-${index}`).innerHTML = '❌ Blocked';
                    document.getElementById(`result-${index}`).className = 'failure';
                }

                // Remove the div
                document.body.removeChild(tempDiv);
            } catch (e) {
                console.error('Error in payload execution:', e);
                document.getElementById(`result-${index}`).innerHTML = '❌ Error';
                document.getElementById(`result-${index}`).className = 'failure';
            } finally {
                // Restore the original alert function
                window.alert = originalAlert;
            }
        }

        async function testAllPayloads(allPages = false) {
            const startIndex = allPages ? 0 : (currentPage - 1) * itemsPerPage;
            const endIndex = allPages ? reportData.length : Math.min(startIndex + itemsPerPage, reportData.length);
            const payloadsToTest = reportData.slice(startIndex, endIndex);

            document.getElementById('testAllButton').disabled = true;
            document.getElementById('testAllButton').innerHTML = 'Testing...';

            for (let i = 0; i < payloadsToTest.length; i++) {
                await testSinglePayload(encodeSpecialChars(payloadsToTest[i].original), startIndex + i);
                // Add a small delay between tests to prevent browser hanging
                await new Promise(resolve => setTimeout(resolve, 10));
            }

            document.getElementById('testAllButton').disabled = false;
            document.getElementById('testAllButton').innerHTML = 'TEST ALL PAYLOADS';
        }

        function displayResults() {
            const contentDiv = document.getElementById('content');
            const totalPages = Math.ceil(reportData.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, reportData.length);
            const pageData = reportData.slice(startIndex, endIndex);

            let summaryHtml = `
                <div class="summary">
                    <h2>Summary</h2>
                    <p>Total alert-triggering payloads: ${reportData.length}</p>
                </div>
            `;

            let tableHtml = `
                <table id="results">
                    <thead>
                        <tr>
                            <th>Original Payload</th>
                            <th>Sanitized Payload</th>
                            <th>Test</th>
                            <th>Result</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${pageData.map((result, index) => `
                            <tr>
                                <td class="payload">${escapeHtml(result.original)}</td>
                                <td class="payload">${escapeHtml(result.sanitized)}</td>
                                <td>${createTestButton(result.original, startIndex + index)}</td>
                                <td><span id="result-${startIndex + index}" class="icon"></span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            contentDiv.innerHTML = summaryHtml + tableHtml;
            updatePagination(totalPages);
        }

        function updatePagination(totalPages) {
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage === totalPages;
            document.getElementById('pageInput').max = totalPages;
        }

        function changePage(delta) {
            currentPage += delta;
            displayResults();
        }

        function goToPage() {
            const pageInput = document.getElementById('pageInput');
            const page = parseInt(pageInput.value);
            if (page && page > 0 && page <= Math.ceil(reportData.length / itemsPerPage)) {
                currentPage = page;
                displayResults();
            } else {
                alert('Invalid page number');
            }
        }

        function displayError(message) {
            const contentDiv = document.getElementById('content');
            contentDiv.innerHTML = `<p class="error-message">${message}</p>`;
        }

        function loadDOMPurifyVersions() {
            fetch('https://api.cdnjs.com/libraries/dompurify?fields=latest,versions')
                .then(response => response.json())
                .then(data => {
                    dompurifyVersions = data.versions;
                    latestVersion = data.latest;
                    const select = document.getElementById('dompurifyVersion');
                    select.innerHTML = `<option value="${latestVersion}">Latest (${latestVersion.split('/').pop().replace('purify.min.js', '')})</option>`;
                    dompurifyVersions.forEach(version => {
                        select.innerHTML += `<option value="https://cdnjs.cloudflare.com/ajax/libs/dompurify/${version}/purify.min.js">${version}</option>`;
                    });
                    loadSelectedVersion();
                })
                .catch(error => {
                    console.error('Error loading DOMPurify versions:', error);
                    displayError('Failed to load DOMPurify versions. Please try again later.');
                });
        }

        function loadSelectedVersion() {
            const select = document.getElementById('dompurifyVersion');
            const selectedVersion = select.value;

            // Remove any existing DOMPurify script
            const existingScript = document.getElementById('dompurifyScript');
            if (existingScript) {
                existingScript.remove();
            }

            // Load the selected DOMPurify version
            const script = document.createElement('script');
            script.id = 'dompurifyScript';
            script.src = selectedVersion;
            script.onload = () => {
                if (reportData) {
                    displayResults();
                }
            };
            script.onerror = () => displayError('Failed to load DOMPurify. Please try another version.');
            document.head.appendChild(script);
        }

        function loadFile() {
            const fileInput = document.getElementById('fileInput');
            if (fileInput.files.length === 0) {
                alert('Please select a file.');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            document.getElementById('loadingMessage').style.display = 'block';

            reader.onload = function(event) {
                try {
                    const jsonData = JSON.parse(event.target.result);
                    reportData = jsonData.filter(item => item.alertTriggered);
                    currentPage = 1;
                    displayResults();
                } catch (e) {
                    console.error('Error parsing JSON!', e);
                    displayError(`Error parsing JSON: ${e.message}`);
                } finally {
                    document.getElementById('loadingMessage').style.display = 'none';
                }
            };

            reader.onerror = function() {
                console.error('Error reading file!');
                displayError('Failed to read file');
                document.getElementById('loadingMessage').style.display = 'none';
            };

            reader.readAsText(file);
        }

        // Initialize by loading DOMPurify versions
        loadDOMPurifyVersions();
    </script>
</body>
</html>